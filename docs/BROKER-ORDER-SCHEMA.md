# üìò **BROKER-ORDER-SCHEMA.md**

### Canonical Schema for BUY / SELL / STOPLOSS Orders (Normalized Across Broker APIs)

This document standardizes the **order format** used inside:

* Execution Engine
* Broker Connector
* Retry Manager
* Logs
* Event Pipeline
* Strategy Manager

It ensures:

* predictable structure
* clean broker integration
* safe ordering
* high-speed encoding/decoding

---

# **1. ORDER OBJECT ‚Äì INTERNAL MASTER FORMAT**

All internal BUY/SELL/STOPLOSS orders generated by the system use this unified schema before being sent to the broker.

```json
{
  "strategy_id": "uuid",
  "user_id": "uuid",
  "symbol": "string",
  "quantity": 1,
  "transaction_type": "BUY | SELL",
  "order_type": "MARKET",
  "trigger_type": "TIME | STOPLOSS",
  "trigger_price": null,
  "timestamp": "ISO-8601",
  "metadata": {}
}
```

### Field Definitions

| Field            | Type             | Description                                                 |
| ---------------- | ---------------- | ----------------------------------------------------------- |
| strategy_id      | UUID             | Identifies which strategy generated the order               |
| user_id          | UUID             | Ensures multi-tenant isolation                              |
| symbol           | string           | Stock symbol (e.g., INFY, TCS)                              |
| quantity         | int              | Always specified in strategy                                |
| transaction_type | BUY / SELL       | Direction of trade                                          |
| order_type       | MARKET           | MVP supports only MARKET orders (PRD simplifies execution)  |
| trigger_type     | TIME or STOPLOSS | Defines event origin                                        |
| trigger_price    | number           | SL value if STOPLOSS; null otherwise                        |
| timestamp        | string           | When order was created                                      |
| metadata         | dict             | Retry count, engine ID, error codes, etc.                   |

---

# **2. BUY ORDER SCHEMA**

BUY is triggered **only by Scheduler time-based event**, per PRD.


### BUY Payload (Internal ‚Üí Broker)

```json
{
  "transaction_type": "BUY",
  "symbol": "INFY",
  "quantity": 10,
  "order_type": "MARKET",
  "trigger_type": "TIME",
  "trigger_price": null
}
```

### BUY Preconditions

* runtime.position == NONE
* buy_time matched
* broker credentials valid

---

# **3. SELL ORDER SCHEMA**

SELL is triggered **only by Scheduler time-based event**, unless STOPLOSS already exited.


### SELL Payload (Internal ‚Üí Broker)

```json
{
  "transaction_type": "SELL",
  "symbol": "INFY",
  "quantity": 10,
  "order_type": "MARKET",
  "trigger_type": "TIME",
  "trigger_price": null
}
```

### SELL Preconditions

* runtime.position == BOUGHT
* sell_time matched
* strategy not exited by STOPLOSS

---

# **4. STOPLOSS ORDER SCHEMA**

STOPLOSS is triggered **only by Market Listener** based on PRD requirement:
‚úî ‚ÄúTrigger stop-loss immediately‚Äù


### STOPLOSS Payload (Internal ‚Üí Broker)

```json
{
  "transaction_type": "SELL",
  "symbol": "INFY",
  "quantity": 10,
  "order_type": "MARKET",
  "trigger_type": "STOPLOSS",
  "trigger_price": 1520.50
}
```

### STOPLOSS Preconditions

* current_price ‚â§ configured stop_loss
* runtime.position == BOUGHT

STOPLOSS always overrides SELL event.

---

# **5. NORMALIZED ORDER SENT TO BROKER CONNECTOR**

Broker Connector receives a **clean, minimal structure**, then converts into the broker's native order payload.

Final internal payload:

```json
{
  "symbol": "INFY",
  "qty": 10,
  "type": "BUY | SELL",
  "order_type": "MARKET",
  "trigger_type": "TIME | STOPLOSS",
  "price": null
}
```

---

# **6. BROKER RESPONSE SCHEMA ‚Äì UNIFIED FORMAT**

Execution Engine always receives a normalized response.

```json
{
  "status": "success | rejected | timeout | error",
  "order_id": "string or null",
  "broker_timestamp": "ISO-8601 or null",
  "message": "string",
  "error_code": "string or null"
}
```

### Required for PRD Safety:

‚úî Retry mechanism
‚úî Log all order attempts
‚úî Detect token or server errors


---

# **7. ERROR RESPONSE SCHEMA**

Used across BUY/SELL/SL failures.

```json
{
  "status": "error",
  "error_type": "BROKER_TIMEOUT | BROKER_REJECTED | TOKEN_INVALID | SERVER_DOWN",
  "details": "string",
  "retry_allowed": true
}
```

Execution Engine uses:

* retry_allowed = true ‚Üí push RETRY event
* retry_allowed = false ‚Üí SAFETY_ABORT

---

# **8. RETRY ORDER SCHEMA**

When an order fails:

```json
{
  "event_type": "RETRY",
  "strategy_id": "uuid",
  "retry_count": 2,
  "original_order": {
    "transaction_type": "BUY",
    "symbol": "INFY",
    "quantity": 10
  }
}
```

Retries capped at **3 attempts**, per PRD.


---

# **9. ORDER LOG SCHEMA**

All orders logged in DB + CloudWatch (PRD 6.5 Logging).


```json
{
  "strategy_id": "uuid",
  "event_type": "BUY | SELL | STOPLOSS | RETRY",
  "request": {},
  "response": {},
  "status": "success | failed",
  "timestamp": "ISO-8601"
}
```

---

# **10. END-TO-END ORDER FLOW SCHEMA**

```
Scheduler (BUY/SELL) or Market Listener (STOPLOSS)
        ‚Üì
Unified Order Schema (internal)
        ‚Üì
Broker Order Schema (converted)
        ‚Üì
Broker API
        ‚Üì
Normalized Success/Failure Response
        ‚Üì
Execution Engine applies updates
        ‚Üì
Runtime updated in Redis
        ‚Üì
Order logged in DB
```

Matches backend workflow described in PRD & SRS.



---

# ‚úî BROKER-ORDER-SCHEMA.md is complete.

### Would you like me to generate:

1Ô∏è‚É£ **BROKER-CONNECTOR-SPEC.md**
2Ô∏è‚É£ **BROKER-STATUS-SCHEMA.md**
3Ô∏è‚É£ **BROKER-ERROR-CATALOG.md**
4Ô∏è‚É£ **BROKER-RETRY-POLICY.md**
5Ô∏è‚É£ **BROKER-FULL-SEQUENCE-DIAGRAM.md (PNG)**


